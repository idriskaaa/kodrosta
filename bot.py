#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Telegram-–±–æ—Ç "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ö–û–î –†–û–°–¢–ê"
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ª–∏–¥-–º–∞–≥–Ω–∏—Ç –¥–ª—è —Å–±–æ—Ä–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤

–í–µ—Ä—Å–∏—è 4.0 ‚Äî —Å UTM-—Ç—Ä–µ–∫–∏–Ω–≥–æ–º, —Ü–µ–ø–æ—á–∫–æ–π –¥–æ–∂–∏–º–∞, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–µ–π—Å–∞–º–∏
"""

import asyncio
import os
import logging
import aiohttp
from datetime import datetime, date
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command, CommandStart, CommandObject
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode

# ============== –ù–ê–°–¢–†–û–ô–ö–ò ==============
BOT_TOKEN = os.getenv("BOT_TOKEN")

# –°—Å—ã–ª–∫–∞ –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥/–æ–ø–ª–∞—Ç—É
LANDING_URL = "https://hamduh.su"
PAY_URL_OFFLINE = "https://payform.ru/4qaH5mp/"
PAY_URL_ONLINE = "https://payform.ru/ngaH5hB/"

# –°—Å—ã–ª–∫–∞ –Ω–∞ –±–æ—Ç–∞ (–¥–ª—è –∫–Ω–æ–ø–∫–∏ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª)
BOT_USERNAME = "diagnostkartaBot"

# –î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–∞ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞)
INTENSIVE_START_DATE = date(2026, 3, 22)

# –í—Ä–µ–º—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
FOLLOWUP_DELAYS = {
    "first": 7200,       # 2 —á–∞—Å–∞ ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–æ —Å–ª–∞–±—É—é –∑–æ–Ω—É
    "second": 86400,     # 24 —á–∞—Å–∞ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–µ–π—Å
    "third": 259200,     # 72 —á–∞—Å–∞ ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏ —Å—Ä–æ—á–Ω–æ—Å—Ç—å
    "final": None,       # –ó–∞ 5 –¥–Ω–µ–π –¥–æ —Å—Ç–∞—Ä—Ç–∞ ‚Äî —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
}

# Google Form –¥–ª—è –∑–∞–ø–∏—Å–∏ –ª–∏–¥–æ–≤
GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScZae3YgUCqa3zYNm0vFipMjCFNzhddf1hXobYlKfb-AowZLA/formResponse"

# ID –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
FORM_FIELDS = {
    "user_id": "entry.935026836",
    "username": "entry.946654961",
    "name": "entry.1428297184",
    "finance": "entry.265824900",
    "sales": "entry.1582343988",
    "processes": "entry.1207325491",
    "team": "entry.1814439416",
    "strategy": "entry.1495083705",
    "total": "entry.2106689105",
    "tag": "entry.1347906002",
}

# ============== –í–û–ü–†–û–°–´ ==============
QUESTIONS = [
    # –ë–ª–æ–∫ –ê: –§–∏–Ω–∞–Ω—Å—ã (1-4)
    {"text": "–í—ã —Ç–æ—á–Ω–æ –∑–Ω–∞–µ—Ç–µ —Å–≤–æ—é —á–∏—Å—Ç—É—é –ø—Ä–∏–±—ã–ª—å –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü (–Ω–µ –≤—ã—Ä—É—á–∫—É)?", "category": "finance"},
    {"text": "–í—ã –∑–Ω–∞–µ—Ç–µ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –≤–∞—à–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞/—É—Å–ª—É–≥–∏?", "category": "finance"},
    {"text": "–£ –≤–∞—Å –µ—Å—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ø–æ–¥—É—à–∫–∞ –º–∏–Ω–∏–º—É–º –Ω–∞ 3 –º–µ—Å—è—Ü–∞ —Ä–∞–±–æ—Ç—ã?", "category": "finance"},
    {"text": "–í—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ) –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç–µ –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫?", "category": "finance"},
    
    # –ë–ª–æ–∫ –ë: –ü—Ä–æ–¥–∞–∂–∏ (5-8)
    {"text": "–í—ã –∑–Ω–∞–µ—Ç–µ –∫–æ–Ω–≤–µ—Ä—Å–∏—é –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –≤–∞—à–µ–π –≤–æ—Ä–æ–Ω–∫–∏ –ø—Ä–æ–¥–∞–∂?", "category": "sales"},
    {"text": "–£ –≤–∞—Å –µ—Å—Ç—å —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–∫—Ä–∏–ø—Ç—ã –ø—Ä–æ–¥–∞–∂?", "category": "sales"},
    {"text": "–ë–æ–ª–µ–µ 30% –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ?", "category": "sales"},
    {"text": "–í—ã —Å–∏—Å—Ç–µ–º–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç–µ —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑–æ–π (–∫–∞—Å–∞–Ω–∏—è, —Ä–∞—Å—Å—ã–ª–∫–∏)?", "category": "sales"},
    
    # –ë–ª–æ–∫ –í: –ü—Ä–æ—Ü–µ—Å—Å—ã (9-12)
    {"text": "–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤ –∫–æ–º–ø–∞–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω—ã –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã?", "category": "processes"},
    {"text": "–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –º–æ–∂–µ—Ç –≤—ã–π—Ç–∏ –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ 2 –Ω–µ–¥–µ–ª–∏ –ø–æ –≤–∞—à–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º?", "category": "processes"},
    {"text": "–ë–∏–∑–Ω–µ—Å –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –≤–∞—Å –º–∏–Ω–∏–º—É–º 2 –Ω–µ–¥–µ–ª–∏?", "category": "processes"},
    {"text": "–£ –≤–∞—Å –µ—Å—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞–Ω—ë—Ä–∫–∏ —Å –∏–∑–º–µ—Ä–∏–º—ã–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏?", "category": "processes"},
    
    # –ë–ª–æ–∫ –ì: –ö–æ–º–∞–Ω–¥–∞ (13-16)
    {"text": "–£ –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –µ—Å—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–µ KPI?", "category": "team"},
    {"text": "–í—ã —Ç—Ä–∞—Ç–∏—Ç–µ –º–µ–Ω–µ–µ 20% –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ ¬´—Ç—É—à–µ–Ω–∏–µ –ø–æ–∂–∞—Ä–æ–≤¬ª?", "category": "team"},
    {"text": "–í –∫–æ–º–∞–Ω–¥–µ –µ—Å—Ç—å —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –≤–∞—Å –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –≤—Ä–µ–º—è –æ—Ç–ø—É—Å–∫–∞?", "category": "team"},
    {"text": "–¢–µ–∫—É—á–∫–∞ –∫–∞–¥—Ä–æ–≤ –º–µ–Ω–µ–µ 20% –≤ –≥–æ–¥?", "category": "team"},
    
    # –ë–ª–æ–∫ –î: –°—Ç—Ä–∞—Ç–µ–≥–∏—è (17-20)
    {"text": "–£ –≤–∞—Å –µ—Å—Ç—å –ø–∏—Å—å–º–µ–Ω–Ω—ã–π –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è –±–∏–∑–Ω–µ—Å–∞ –Ω–∞ –≥–æ–¥?", "category": "strategy"},
    {"text": "–í—ã —Ç–æ—á–Ω–æ –∑–Ω–∞–µ—Ç–µ, –∫—Ç–æ –≤–∞—à –∏–¥–µ–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç?", "category": "strategy"},
    {"text": "–í—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ —Å–≤–æ—ë –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –∏ –º–æ–∂–µ—Ç–µ –æ–±—ä—è—Å–Ω–∏—Ç—å –µ–≥–æ –∑–∞ 30 —Å–µ–∫—É–Ω–¥?", "category": "strategy"},
    {"text": "–í—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ (–µ–∂–µ–º–µ—Å—è—á–Ω–æ) –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç–µ –ø–ª–∞–Ω?", "category": "strategy"},
]

# –ù–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
CATEGORY_NAMES = {
    "finance": "üí∞ –§–∏–Ω–∞–Ω—Å—ã",
    "sales": "üìà –ü—Ä–æ–¥–∞–∂–∏", 
    "processes": "‚öôÔ∏è –ü—Ä–æ—Ü–µ—Å—Å—ã",
    "team": "üë• –ö–æ–º–∞–Ω–¥–∞",
    "strategy": "üöÄ –°—Ç—Ä–∞—Ç–µ–≥–∏—è"
}

CATEGORY_NAMES_SHORT = {
    "finance": "–§–∏–Ω–∞–Ω—Å—ã",
    "sales": "–ü—Ä–æ–¥–∞–∂–∏", 
    "processes": "–ü—Ä–æ—Ü–µ—Å—Å—ã –∏ —Å–∏—Å—Ç–µ–º–∞",
    "team": "–ö–æ–º–∞–Ω–¥–∞",
    "strategy": "–°—Ç—Ä–∞—Ç–µ–≥–∏—è"
}

CATEGORY_ORDER = ["finance", "sales", "processes", "team", "strategy"]

# ============== –î–ï–¢–ê–õ–¨–ù–´–ï –¢–ï–ö–°–¢–´ –î–õ–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ==============

DIAGNOSTIC_TEXTS = {
    "finance": {
        "critical": """üî¥ <b>–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–û–ù–ê</b>

–í—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ –±–∏–∑–Ω–µ—Å–æ–º –≤—Å–ª–µ–ø—É—é. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –≤—ã –ø—É—Ç–∞–µ—Ç–µ –æ–±–æ—Ä–æ—Ç —Å —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª—å—é. 

–ï—Å—Ç—å —Ä–∏—Å–∫, —á—Ç–æ –≤—ã –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç–µ —É–±—ã—Ç–∫–∏: —á–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–¥–∞—ë—Ç–µ, —Ç–µ–º –º–µ–Ω—å—à–µ –¥–µ–Ω–µ–≥ –≤ –∫–∞—Ä–º–∞–Ω–µ. 

<b>–í–∞–º —Å—Ä–æ—á–Ω–æ –Ω—É–∂–Ω–∞ –æ—Ü–∏—Ñ—Ä–æ–≤–∫–∞ —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∏.</b>""",
        
        "risk": """üü° <b>–ó–û–ù–ê –†–ò–°–ö–ê</b>

–î–µ–Ω—å–≥–∏ –µ—Å—Ç—å, –Ω–æ –æ–Ω–∏ "—Ä–∞–∑–º—ã—Ç—ã". –í—ã –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –∫–∞—Å—Å–æ–≤—ã—Ö —Ä–∞–∑—Ä—ã–≤–æ–≤, –∞ –≤–∞—à–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫—Ä—ã—Ç—ã–µ —Ä–∞—Å—Ö–æ–¥—ã. 

<b>–í—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –º–Ω–æ–≥–æ, –Ω–æ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ –º–µ–Ω—å—à–µ, —á–µ–º –º–æ–≥–ª–∏ –±—ã.</b>""",
        
        "stable": """üü¢ <b>–°–¢–ê–ë–ò–õ–¨–ù–û</b>

–£ –≤–∞—Å –µ—Å—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ü–∏—Ñ—Ä, –Ω–æ, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç —Å–∏—Å—Ç–µ–º—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. 

<b>–í—ã –≥–æ—Ç–æ–≤—ã –∫ —Ä–æ—Å—Ç—É, –µ—Å–ª–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç–µ –ø–ª–∞—Ç—ë–∂–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã.</b>"""
    },
    
    "sales": {
        "critical": """üî¥ <b>–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–û–ù–ê</b>

–í–∞—à–∞ –≤–æ—Ä–æ–Ω–∫–∞ ‚Äî —ç—Ç–æ —Ä–µ—à–µ—Ç–æ. –í—ã –≤–∫–ª–∞–¥—ã–≤–∞–µ—Ç–µ –¥–µ–Ω—å–≥–∏ –≤ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥, –Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä—ã "—Å–ª–∏–≤–∞—é—Ç" –ª–∏–¥–æ–≤ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ —Å–∏—Å—Ç–µ–º—ã –∫–∞—Å–∞–Ω–∏–π. 

<b>–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤—ã —Ç–µ—Ä—è–µ—Ç–µ –¥–µ–Ω—å–≥–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ –Ω–µ –¥–æ–∂–∏–º–∞–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤.</b>""",
        
        "risk": """üü° <b>–ó–û–ù–ê –†–ò–°–ö–ê</b>

–ü—Ä–æ–¥–∞–∂–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Å–ª—É—á–∞—è –∏–ª–∏ —Ç–∞–ª–∞–Ω—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ª—é–¥–µ–π. –ù–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Å–∏–∏. 

<b>–ß—Ç–æ–±—ã —Ä–∞—Å—Ç–∏, –≤–∞–º –Ω—É–∂–Ω–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –ø—Ä–æ–¥–∞–∂–∏ –∏–∑ "–∏—Å–∫—É—Å—Å—Ç–≤–∞" –≤ –∫–æ–Ω–≤–µ–π–µ—Ä —Å —á—ë—Ç–∫–∏–º–∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞–º–∏.</b>""",
        
        "stable": """üü¢ <b>–°–¢–ê–ë–ò–õ–¨–ù–û</b>

–ü—Ä–æ–¥–∞–∂–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–ø–ª–æ—Ö–æ, –Ω–æ –≤—ã —É–ø–∏—Ä–∞–µ—Ç–µ—Å—å –≤ –ø–æ—Ç–æ–ª–æ–∫. 

<b>–†–æ—Å—Ç –≤–æ–∑–º–æ–∂–µ–Ω —á–µ—Ä–µ–∑ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –¥–æ–ø—Ä–æ–¥–∞–∂ –∏ —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–æ–π, –æ –∫–æ—Ç–æ—Ä–æ–π –≤—ã, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –∑–∞–±—ã–≤–∞–µ—Ç–µ.</b>"""
    },
    
    "processes": {
        "critical": """üî¥ <b>–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–û–ù–ê</b>

–í—ã ‚Äî –≥–ª–∞–≤–Ω—ã–π —Ä–∞–± —Å–≤–æ–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –í—Å—ë –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ –≤–∞—à–µ–º –ª–∏—á–Ω–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–µ. –ï—Å–ª–∏ –≤—ã –æ—Ç–∫–ª—é—á–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞ –¥–µ–Ω—å, —Ä–∞–±–æ—Ç–∞ –≤—Å—Ç–∞–Ω–µ—Ç. 

<b>–≠—Ç–æ –Ω–µ –±–∏–∑–Ω–µ—Å, —ç—Ç–æ —Å–∞–º–æ–∑–∞–Ω—è—Ç–æ—Å—Ç—å —Å –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π.</b>""",
        
        "risk": """üü° <b>–ó–û–ù–ê –†–ò–°–ö–ê</b>

–£ –≤–∞—Å –µ—Å—Ç—å –ø–æ–ø—ã—Ç–∫–∏ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ –≤—ã —á–∞—Å—Ç–æ –ø–µ—Ä–µ–¥–µ–ª—ã–≤–∞–µ—Ç–µ —Ä–∞–±–æ—Ç—É –∑–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏. –•–∞–æ—Å –≤ –∑–∞–¥–∞—á–∞—Ö —Å—ä–µ–¥–∞–µ—Ç 80% –≤–∞—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. 

<b>–í–∞–º –Ω—É–∂–Ω–∞ –º–∞—Ç—Ä–∏—Ü–∞ –∑–∞–¥–∞—á –∏ –∂—ë—Å—Ç–∫–∏–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã.</b>""",
        
        "stable": """üü¢ <b>–°–¢–ê–ë–ò–õ–¨–ù–û</b>

–û—Å–Ω–æ–≤—ã —Å–∏—Å—Ç–µ–º—ã –∑–∞–ª–æ–∂–µ–Ω—ã. 

<b>–ß—Ç–æ–±—ã –≤—ã–π—Ç–∏ –Ω–∞ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å, –≤–∞–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—Ç–∞—Ç—å –±—ã—Ç—å "—Ç—É—à–∏—Ç–µ–ª–µ–º –ø–æ–∂–∞—Ä–æ–≤" –∏ –∑–∞–Ω—è—Ç—å—Å—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º.</b>"""
    },
    
    "team": {
        "critical": """üî¥ <b>–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–û–ù–ê</b>

–ö–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç "–æ—Ç –∑–≤–æ–Ω–∫–∞ –¥–æ –∑–≤–æ–Ω–∫–∞". –ù–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É (KPI). –í—ã –±–æ–∏—Ç–µ—Å—å —É–≤–æ–ª—å–Ω—è—Ç—å —Å–ª–∞–±—ã—Ö, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ —É–º–µ–µ—Ç–µ –±—ã—Å—Ç—Ä–æ –Ω–∞–Ω–∏–º–∞—Ç—å —Å–∏–ª—å–Ω—ã—Ö. 

<b>–õ—é–¥–∏ ‚Äî –≤–∞—à–µ —Å–ª–∞–±–æ–µ –∑–≤–µ–Ω–æ.</b>""",
        
        "risk": """üü° <b>–ó–û–ù–ê –†–ò–°–ö–ê</b>

–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –≤—Ä–æ–¥–µ –±—ã —Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è, –Ω–æ –≤—ã –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç–µ –∏—Ö —Ä–µ–∞–ª—å–Ω—É—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –≤ –∫–æ–º–∞–Ω–¥–µ —á–∞—Å—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—à–∏–±–∫–∞–º. 

<b>–ù—É–∂–Ω–æ –≤–Ω–µ–¥—Ä—è—Ç—å —Å–∏—Å—Ç–µ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –æ—Ç—á—ë—Ç—ã.</b>""",
        
        "stable": """üü¢ <b>–°–¢–ê–ë–ò–õ–¨–ù–û</b>

–£ –≤–∞—Å —Ö–æ—Ä–æ—à–∞—è –∫–æ–º–∞–Ω–¥–∞, –Ω–æ –æ–Ω–∞ –Ω–µ –∑–Ω–∞–µ—Ç –≤–∞—à–∏—Ö —Ü–µ–ª–µ–π –Ω–∞ 90 –¥–Ω–µ–π. 

<b>–ü–æ—Ä–∞ –≤–æ–≤–ª–µ–∫–∞—Ç—å –∏—Ö –≤ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∏ –¥–∞–≤–∞—Ç—å –±–æ–ª—å—à–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.</b>"""
    },
    
    "strategy": {
        "critical": """üî¥ <b>–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–û–ù–ê</b>

–í—ã –∂–∏–≤—ë—Ç–µ –≤ —Ä–µ–∂–∏–º–µ "–≤—ã–∂–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è". –£ –≤–∞—Å –Ω–µ—Ç –ø–ª–∞–Ω–∞ –¥–∞–∂–µ –Ω–∞ –º–µ—Å—è—Ü –≤–ø–µ—Ä—ë–¥. 

<b>–ë–µ–∑ –≤–µ–∫—Ç–æ—Ä–∞ —Ä–∞–∑–≤–∏—Ç–∏—è –ª—é–±–æ–π –∫—Ä–∏–∑–∏—Å –Ω–∞ —Ä—ã–Ω–∫–µ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —Ñ–∞—Ç–∞–ª—å–Ω—ã–º.</b>""",
        
        "risk": """üü° <b>–ó–û–ù–ê –†–ò–°–ö–ê</b>

–¶–µ–ª–∏ –µ—Å—Ç—å –≤ –≥–æ–ª–æ–≤–µ, –Ω–æ –∏—Ö –Ω–µ—Ç –Ω–∞ –±—É–º–∞–≥–µ. –í—ã –≤–∏–¥–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –∑–∞ –Ω–∏—Ö —É—Ö–≤–∞—Ç–∏—Ç—å—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –∑–∞–≤–∞–ª–µ–Ω—ã —Ç–µ–∫—É—á–∫–æ–π. 

<b>–í–∞–º –Ω—É–∂–µ–Ω –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –Ω–∞ 90 –¥–Ω–µ–π.</b>""",
        
        "stable": """üü¢ <b>–°–¢–ê–ë–ò–õ–¨–ù–û</b>

–í—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ, –∫—É–¥–∞ –∏–¥—ë—Ç–µ, –Ω–æ, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è. 

<b>–í–∞–º –Ω—É–∂–Ω–æ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ "–æ–¥–Ω–æ–º –≥–ª–∞–≤–Ω–æ–º –¥–µ–π—Å—Ç–≤–∏–∏", –∫–æ—Ç–æ—Ä–æ–µ –¥–∞—Å—Ç —Ö2 –∫ –ø—Ä–∏–±—ã–ª–∏.</b>"""
    }
}

# ============== –ü–ï–†–°–û–ù–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –ö–ï–ô–°–´ –î–õ–Ø –î–û–ñ–ò–ú–ê ==============

FOLLOWUP_CASES = {
    "finance": {
        "title": "–§–∏–Ω–∞–Ω—Å—ã –∏ —É—á—ë—Ç",
        "case": """–†–∞–∑–±–∏—Ä–∞–ª–∏ —Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—É—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏. –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫ —Ö–æ—Ç–µ–ª –∑–∞–∫—Ä—ã—Ç—å –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é ‚Äî —Å—á–∏—Ç–∞–ª –µ—ë —É–±—ã—Ç–æ—á–Ω–æ–π.

–ö–æ–≥–¥–∞ —Ä–∞–∑–ª–æ–∂–∏–ª–∏ —Ä–∞—Å—Ö–æ–¥—ã ‚Äî –æ–∫–∞–∑–∞–ª–æ—Å—å, –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è –≥–æ–¥–∞–º–∏ —Å–∫–∏–¥—ã–≤–∞–ª–∞ –Ω–∞ —ç—Ç—É –ø–æ–∑–∏—Ü–∏—é –í–°–ï –æ–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã. –ê—Ä–µ–Ω–¥–∞, –ª–æ–≥–∏—Å—Ç–∏–∫–∞, –Ω–∞–∫–ª–∞–¥–Ω—ã–µ ‚Äî –≤—Å—ë —Ç—É–¥–∞.

–ü–æ—Å–ª–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—ã—è—Å–Ω–∏–ª–æ—Å—å: —ç—Ç–∞ –ø–æ–∑–∏—Ü–∏—è ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è, –∫–æ—Ç–æ—Ä–∞—è –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –∫–æ—Ä–º–∏–ª–∞ –±–∏–∑–Ω–µ—Å. –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç—Ä–∏ ¬´–ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö¬ª –ø—Ä–æ–¥—É–∫—Ç–∞ —Ä–∞–±–æ—Ç–∞–ª–∏ –≤ –Ω–æ–ª—å.

–ï—Å–ª–∏ –±—ã —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫ –∑–∞–∫—Ä—ã–ª –µ—ë –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞ ‚Äî —É–±–∏–ª –±—ã –±–∏–∑–Ω–µ—Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ä—É–∫–∞–º–∏.""",
        "day_link": "–ù–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–µ –≤ –î–µ–Ω—å 1 –º—ã —Å—á–∏—Ç–∞–µ–º —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫—É –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ ‚Äî —á—Ç–æ–±—ã –≤—ã —Ç–æ—á–Ω–æ –∑–Ω–∞–ª–∏, —á—Ç–æ –≤–∞—Å –∫–æ—Ä–º–∏—Ç, –∞ —á—Ç–æ —Å—ä–µ–¥–∞–µ—Ç."
    },
    
    "sales": {
        "title": "–ü—Ä–æ–¥–∞–∂–∏ –∏ –≤–æ—Ä–æ–Ω–∫–∞",
        "case": """–ö–æ–º–ø–∞–Ω–∏—è –ø–æ –ø—Ä–æ–¥–∞–∂–µ –æ–∫–æ–Ω. 200 –∑–∞—è–≤–æ–∫ –≤ –º–µ—Å—è—Ü, –ø–æ–∫—É–ø–∞–ª–∏ 18 —á–µ–ª–æ–≤–µ–∫. –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫ —Å—á–∏—Ç–∞–ª, —á—Ç–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.

–†–∞–∑–ª–æ–∂–∏–ª–∏ –≤–æ—Ä–æ–Ω–∫—É –ø–æ —ç—Ç–∞–ø–∞–º ‚Äî –ø—Ä–æ–≤–∞–ª –æ–∫–∞–∑–∞–ª—Å—è –º–µ–∂–¥—É –ø–µ—Ä–≤—ã–º –∑–≤–æ–Ω–∫–æ–º –∏ —Ä–∞—Å—á—ë—Ç–æ–º. 60 —á–µ–ª–æ–≤–µ–∫ –æ—Ç–≤–∞–ª–∏–≤–∞–ª–∏—Å—å. –ü–æ—Å–ª—É—à–∞–ª–∏ –∑–∞–ø–∏—Å–∏ ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä—ã 8 –º–∏–Ω—É—Ç —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ 30 —Å–µ–∫—É–Ω–¥ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏ ¬´–Ω—É —á—Ç–æ, –ø–æ—Å—á–∏—Ç–∞—Ç—å?¬ª.

–ü–µ—Ä–µ–ø–∏—Å–∞–ª–∏ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç. –î–æ —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–∞–ª–∏ –¥–æ—Ö–æ–¥–∏—Ç—å –Ω–µ 80, –∞ 120 —á–µ–ª–æ–≤–µ–∫. –ü—Ä–æ–¥–∞–∂–∏ –≤—ã—Ä–æ—Å–ª–∏ —Å 18 –¥–æ 27 ‚Äî —Ç–µ –∂–µ –∑–∞—è–≤–∫–∏, —Ç–æ—Ç –∂–µ –±—é–¥–∂–µ—Ç, +630 —Ç—ã—Å—è—á –≤—ã—Ä—É—á–∫–∏ –≤ –º–µ—Å—è—Ü.""",
        "day_link": "–ù–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–µ –≤ –î–µ–Ω—å 3 —Å—Ç—Ä–æ–∏–º –≤–∞—à—É –≤–æ—Ä–æ–Ω–∫—É —Å —Ü–∏—Ñ—Ä–∞–º–∏, –Ω–∞—Ö–æ–¥–∏–º –¥—ã—Ä—É –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ç–µ—Ö–Ω–∏–∫–∞–º–∏."
    },
    
    "processes": {
        "title": "–ü—Ä–æ—Ü–µ—Å—Å—ã –∏ —Å–∏—Å—Ç–µ–º–∞",
        "case": """–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç–∞–ª 12‚Äì14 —á–∞—Å–æ–≤. –°–∞–º –ø—Ä–æ–≤–µ—Ä—è–ª –∑–∞—è–≤–∫–∏, —Ä–µ—à–∞–ª –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞–ª –≤–æ–¥–∏—Ç–µ–ª–µ–π. –í—ã—Ä—É—á–∫–∞ 4,5 –º–ª–Ω, –∞ —Å–µ–±–µ ‚Äî –Ω–æ–ª—å.

–í—ã–ø–∏—Å–∞–ª–∏ –≤—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞ –Ω–µ–¥–µ–ª—é ‚Äî 47 –ø—É–Ω–∫—Ç–æ–≤. –†–∞–∑–ª–æ–∂–∏–ª–∏ –ø–æ –º–∞—Ç—Ä–∏—Ü–µ. 34 –∏–∑ 47 –º–æ–≥ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å –∑–∞—Ä–ø–ª–∞—Ç–æ–π 50‚Äì70 —Ç—ã—Å—è—á.

–ó–∞ 3 –º–µ—Å—è—Ü–∞ –ø–µ—Ä–µ–¥–∞–ª 28 –∑–∞–¥–∞—á. –ù–∞–ø–∏—Å–∞–ª –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–æ—Å—Ç–æ–º—É —à–∞–±–ª–æ–Ω—É. –û—Å–≤–æ–±–æ–¥–∏–ª 6 —á–∞—Å–æ–≤ –≤ –¥–µ–Ω—å. –ù–∞–ø—Ä–∞–≤–∏–ª –≤—Ä–µ–º—è –Ω–∞ –Ω–æ–≤–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî —á–µ—Ä–µ–∑ –ø–æ–ª–≥–æ–¥–∞ –æ–Ω–æ –ø—Ä–∏–Ω–æ—Å–∏–ª–æ +1,2 –º–ª–Ω –≤ –º–µ—Å—è—Ü.""",
        "day_link": "–ù–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–µ –≤ –î–µ–Ω—å 5 ‚Äî –º–∞—Ç—Ä–∏—Ü–∞ –∑–∞–¥–∞—á —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞, —Ñ–æ—Ä–º—É–ª–∞ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —à–∞–±–ª–æ–Ω –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∑–∞ 15 –º–∏–Ω—É—Ç."
    },
    
    "team": {
        "title": "–ö–æ–º–∞–Ω–¥–∞ –∏ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ",
        "case": """–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –≤—ë–ª —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π —É—á—ë—Ç. –í–æ–æ–±—â–µ. –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è —Å–¥–∞–≤–∞–ª–∞ –æ—Ç—á—ë—Ç—ã –≤ –Ω–∞–ª–æ–≥–æ–≤—É—é, –Ω–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∫–∞—Ä—Ç–∏–Ω—ã –Ω–µ –±—ã–ª–æ.

–í–Ω–µ–¥—Ä–∏–ª–∏ —Å–∏—Å—Ç–µ–º—É —É—á—ë—Ç–∞ ‚Äî –∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª–æ—Å—å: –∫–æ–º–ø–∞–Ω–∏–∏ –ø—Ä–µ–¥—ä—è–≤–ª—è–ª–∏ –¥–æ–ª–≥–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ. –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã –≤—ã—Å—Ç–∞–≤–ª—è–ª–∏ —Å—É–º–º—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –±—ã–ª–∏ –æ–ø–ª–∞—á–µ–Ω—ã –∏–ª–∏ –Ω–µ –∏–º–µ–ª–∏ –æ—Å–Ω–æ–≤–∞–Ω–∏—è. –ê –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±—ã–ª–æ –Ω–µ–ª—å–∑—è ‚Äî –Ω–µ –±—ã–ª–æ —Å–≤–æ–µ–π —Å–∏—Å—Ç–µ–º—ã.

–°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ —É—à–ª–æ –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–ª–≥–∏ –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è ‚Äî –ø–æ—Å—á–∏—Ç–∞—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ. –ü–æ—Å–ª–µ ‚Äî –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ç–∞–∫–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞.""",
        "day_link": "–ù–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–µ –≤ –î–µ–Ω—å 1 –º—ã –Ω–∞—á–∏–Ω–∞–µ–º —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ —Ü–∏—Ñ—Ä ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ –±–µ–∑ —Å–∏—Å—Ç–µ–º—ã —É—á—ë—Ç–∞ –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ –≤—Å–ª–µ–ø—É—é."
    },
    
    "strategy": {
        "title": "–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ",
        "case": """–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–ª–∞ –Ω–∞ –æ–ø—Ç–µ. –í—Å—ë –±—ã–ª–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ, –ø–æ–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –Ω–µ –∑–∞—à–ª–∏ —Å –¥–µ—à—ë–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–µ–π. –î–µ–º–ø–∏–Ω–≥, —Å–∫–∏–¥–∫–∏ ‚Äî –º–∞—Ä–∂–∞ —Å–∂–∞–ª–∞—Å—å –¥–æ –Ω—É–ª—è.

–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫ –±—ã–ª –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ ¬´–≤—Å—ë, –∫–æ–Ω–µ—Ü¬ª. –ö–æ–Ω–∫—É—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ü–µ–Ω–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.

–†–µ—à–µ–Ω–∏–µ ‚Äî –≤—ã—Ö–æ–¥ –≤ —Ä–æ–∑–Ω–∏—Ü—É. –î—Ä—É–≥–æ–π –∫–∞–Ω–∞–ª, –¥—Ä—É–≥–æ–π –∫–ª–∏–µ–Ω—Ç, –¥—Ä—É–≥–∞—è —Ü–µ–Ω–æ–≤–∞—è –Ω–∏—à–∞. –¢–æ—Ç –∂–µ –ø—Ä–æ–¥—É–∫—Ç, –Ω–æ –¥–ª—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ –∫–∞—á–µ—Å—Ç–≤—É, –∞ –Ω–µ –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–µ.

–ö–æ–º–ø–∞–Ω–∏—è –≤—ã—à–ª–∞ –∏–∑ —Ü–µ–Ω–æ–≤–æ–π –≤–æ–π–Ω—ã –∏ –∑–∞–Ω—è–ª–∞ –Ω–∏—à—É, –≥–¥–µ –∫–∞—á–µ—Å—Ç–≤–æ —Å—Ç–∞–ª–æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ–º.""",
        "day_link": "–ù–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–µ –º—ã —Ä–∞–∑–±–∏—Ä–∞–µ–º –∏ –≤–æ—Ä–æ–Ω–∫—É, –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤—É—é –ª–∏–Ω–µ–π–∫—É. –î–µ–Ω—å 3 ‚Äî –∞–Ω–∞—Ç–æ–º–∏—è –≤–æ—Ä–æ–Ω–∫–∏. –î–µ–Ω—å 2 ‚Äî —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–æ—Å—Ç–∞."
    }
}

# ============== –°–û–°–¢–û–Ø–ù–ò–Ø ==============
class DiagnosticStates(StatesGroup):
    answering = State()

# ============== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==============
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –°–æ–∑–¥–∞—ë–º –±–æ—Ç–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
bot = Bot(
    token=BOT_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
followup_tasks = {}

# ============== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==============

def get_days_until_start() -> int:
    """–°—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ —Å—Ç–∞—Ä—Ç–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–∞"""
    today = date.today()
    delta = INTENSIVE_START_DATE - today
    return max(0, delta.days)

def get_countdown_text() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞"""
    days = get_days_until_start()
    if days == 0:
        return "üî• –ò–Ω—Ç–µ–Ω—Å–∏–≤ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–µ–≥–æ–¥–Ω—è!"
    elif days == 1:
        return "‚è∞ –î–æ —Å—Ç–∞—Ä—Ç–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–∞ ‚Äî 1 –¥–µ–Ω—å!"
    elif days <= 5:
        return f"‚è∞ –î–æ —Å—Ç–∞—Ä—Ç–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–∞ ‚Äî {days} –¥–Ω–µ–π!"
    elif days <= 14:
        return f"üìÖ –î–æ —Å—Ç–∞—Ä—Ç–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–∞ ‚Äî {days} –¥–Ω–µ–π"
    else:
        return f"üìÖ –î–æ —Å—Ç–∞—Ä—Ç–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–∞ ‚Äî {days} –¥–Ω–µ–π"

def get_status_text(category: str, score: int) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –±–∞–ª–ª–∞–º"""
    if score <= 1:
        return DIAGNOSTIC_TEXTS[category]["critical"]
    elif score == 2:
        return DIAGNOSTIC_TEXTS[category]["risk"]
    else:
        return DIAGNOSTIC_TEXTS[category]["stable"]

def get_status_emoji(score: int) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–º–æ–¥–∑–∏ —Å—Ç–∞—Ç—É—Å–∞"""
    if score <= 1:
        return "üî¥"
    elif score == 2:
        return "üü°"
    else:
        return "üü¢"

def calculate_results(answers: list) -> dict:
    """–ü–æ–¥—Å—á—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"""
    scores = {cat: 0 for cat in CATEGORY_ORDER}
    
    for i, answer in enumerate(answers):
        if answer == "yes":
            category = QUESTIONS[i]["category"]
            scores[category] += 1
    
    return scores

def get_worst_category(scores: dict) -> str:
    """–ù–∞—Ö–æ–¥–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –±–∞–ª–ª–æ–º"""
    min_score = min(scores.values())
    for cat in CATEGORY_ORDER:
        if scores[cat] == min_score:
            return cat
    return CATEGORY_ORDER[0]

def get_tag(category: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–≥ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
    tags = {
        "finance": "finance_problem",
        "sales": "sales_problem",
        "processes": "processes_problem",
        "team": "team_problem",
        "strategy": "strategy_problem"
    }
    return tags.get(category, "unknown")

# ============== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==============

def get_start_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞"""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üöÄ –ù–∞—á–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É", callback_data="start_diagnostic")]
    ])

def get_answer_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤"""
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="‚úÖ –î–∞", callback_data="answer_yes"),
            InlineKeyboardButton(text="‚ùå –ù–µ—Ç", callback_data="answer_no")
        ]
    ])

def get_final_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Äî —Å –∫–Ω–æ–ø–∫–æ–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª"""
    share_text = "–ü—Ä–æ—à—ë–ª –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –±–∏–∑–Ω–µ—Å–∞ –∑–∞ 3 –º–∏–Ω—É—Ç—ã ‚Äî –±–æ—Ç –ø–æ–∫–∞–∑–∞–ª, –≥–¥–µ —Ç–µ—Ä—è—é –¥–µ–Ω—å–≥–∏. –ü–æ–ø—Ä–æ–±—É–π:"
    share_url = f"https://t.me/{BOT_USERNAME}"
    
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üî• –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨ –ú–ï–°–¢–û", url=LANDING_URL)],
        [InlineKeyboardButton(
            text="üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥—É",
            url=f"https://t.me/share/url?url={share_url}&text={share_text}"
        )]
    ])

def get_details_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π"""
    share_text = "–ü—Ä–æ—à—ë–ª –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –±–∏–∑–Ω–µ—Å–∞ –∑–∞ 3 –º–∏–Ω—É—Ç—ã ‚Äî –±–æ—Ç –ø–æ–∫–∞–∑–∞–ª, –≥–¥–µ —Ç–µ—Ä—è—é –¥–µ–Ω—å–≥–∏. –ü–æ–ø—Ä–æ–±—É–π:"
    share_url = f"https://t.me/{BOT_USERNAME}"
    
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìä –ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä –ø–æ –±–ª–æ–∫–∞–º", callback_data="show_details")],
        [InlineKeyboardButton(text="üî• –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨ –ú–ï–°–¢–û", url=LANDING_URL)],
        [InlineKeyboardButton(
            text="üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥—É",
            url=f"https://t.me/share/url?url={share_url}&text={share_text}"
        )]
    ])

def get_followup_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è follow-up —Å–æ–æ–±—â–µ–Ω–∏–π"""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üî• –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨ –ú–ï–°–¢–û", url=LANDING_URL)]
    ])

# ============== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==============

@dp.message(CommandStart())
async def cmd_start(message: types.Message, state: FSMContext, command: CommandObject):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π UTM-–º–µ—Ç–æ–∫ (deep link)"""
    await state.clear()
    
    # –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –±—ã–ª–∏
    user_id = message.from_user.id
    if user_id in followup_tasks:
        for task in followup_tasks[user_id]:
            task.cancel()
        del followup_tasks[user_id]
    
    # –õ–æ–≤–∏–º UTM-–º–µ—Ç–∫—É –∏–∑ deep link –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (?start=utm_source)
    utm_source = ""
    if command.args:
        utm_source = command.args.strip()
        logger.info(f"User {user_id} started with UTM: {utm_source}")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º UTM-–º–µ—Ç–∫—É –≤ state
    await state.update_data(utm_source=utm_source)
    
    # –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç
    countdown = get_countdown_text()
    
    welcome_text = f"""üéØ <b>–≠–∫—Å–ø—Ä–µ—Å—Å-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞</b>

–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π –Ω–µ –∑–Ω–∞—é—Ç, –≥–¥–µ –∏—Ö –±–∏–∑–Ω–µ—Å —Ç–µ—Ä—è–µ—Ç –¥–µ–Ω—å–≥–∏. –ù–µ –ø–æ—Ç–æ–º—É —á—Ç–æ –≥–ª—É–ø—ã–µ ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ —Å—á–∏—Ç–∞–ª–∏.

–≠—Ç–æ—Ç —Ç–µ—Å—Ç –∑–∞ 3 –º–∏–Ω—É—Ç—ã –ø–æ–∫–∞–∂–µ—Ç:
‚Ä¢ –ì–¥–µ –≤–∞—à –±–∏–∑–Ω–µ—Å —Ç–µ—Ä—è–µ—Ç –¥–µ–Ω—å–≥–∏
‚Ä¢ –ß—Ç–æ —Ç–æ—Ä–º–æ–∑–∏—Ç —Ä–æ—Å—Ç
‚Ä¢ –° —á–µ–≥–æ –Ω–∞—á–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

üìä 20 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ 5 –∫–ª—é—á–µ–≤—ã–º –æ–±–ª–∞—Å—Ç—è–º
üéÅ –í –∫–æ–Ω—Ü–µ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

{countdown}

–û—Ç–≤–µ—á–∞–π—Ç–µ —á–µ—Å—Ç–Ω–æ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–≤–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ –≤—ã."""

    await message.answer(
        welcome_text,
        parse_mode="HTML",
        reply_markup=get_start_keyboard()
    )

@dp.callback_query(F.data == "start_diagnostic")
async def start_diagnostic(callback: types.CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"""
    await callback.answer()
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π UTM
    data = await state.get_data()
    utm_source = data.get("utm_source", "")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
    await state.update_data(
        answers=[],
        current_question=0,
        user_id=callback.from_user.id,
        username=callback.from_user.username or "",
        first_name=callback.from_user.first_name or "",
        start_time=datetime.now().isoformat(),
        utm_source=utm_source  # –°–æ—Ö—Ä–∞–Ω—è–µ–º UTM —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    )
    await state.set_state(DiagnosticStates.answering)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
    await send_question(callback.message, state)

async def send_question(message: types.Message, state: FSMContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å"""
    data = await state.get_data()
    current = data.get("current_question", 0)
    
    if current >= len(QUESTIONS):
        await show_results(message, state)
        return
    
    question = QUESTIONS[current]
    q_num = current + 1
    total = len(QUESTIONS)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–ª–æ–∫
    if current < 4:
        block = "üí∞ –§–∏–Ω–∞–Ω—Å—ã"
    elif current < 8:
        block = "üìà –ü—Ä–æ–¥–∞–∂–∏"
    elif current < 12:
        block = "‚öôÔ∏è –ü—Ä–æ—Ü–µ—Å—Å—ã"
    elif current < 16:
        block = "üë• –ö–æ–º–∞–Ω–¥–∞"
    else:
        block = "üöÄ –°—Ç—Ä–∞—Ç–µ–≥–∏—è"
    
    # –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    progress = "‚ñì" * (q_num * 20 // total) + "‚ñë" * (20 - q_num * 20 // total)
    
    text = f"""<b>–í–æ–ø—Ä–æ—Å {q_num} –∏–∑ {total}</b>
{progress}

<i>{block}</i>

{question['text']}"""

    await message.edit_text(
        text,
        parse_mode="HTML",
        reply_markup=get_answer_keyboard()
    )

@dp.callback_query(F.data.startswith("answer_"), DiagnosticStates.answering)
async def process_answer(callback: types.CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞"""
    data = await state.get_data()
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
    last_click = data.get("last_click", 0)
    now = datetime.now().timestamp()
    if now - last_click < 1:
        await callback.answer("–ü–æ–¥–æ–∂–¥–∏—Ç–µ...")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
    current = data.get("current_question", 0)
    answers = data.get("answers", [])
    
    if len(answers) > current:
        await callback.answer()
        return
    
    await callback.answer()
    
    answer = "yes" if callback.data == "answer_yes" else "no"
    
    answers.append(answer)
    current += 1
    
    await state.update_data(answers=answers, current_question=current, last_click=now)
    
    if current >= len(QUESTIONS):
        await show_results(callback.message, state)
    else:
        await send_question(callback.message, state)

async def show_results(message: types.Message, state: FSMContext):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"""
    data = await state.get_data()
    answers = data.get("answers", [])
    user_id = data.get("user_id")
    
    # –ü–æ–¥—Å—á—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    scores = calculate_results(answers)
    worst_category = get_worst_category(scores)
    worst_name = CATEGORY_NAMES_SHORT[worst_category]
    tag = get_tag(worst_category)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º scores –≤ state –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    await state.update_data(scores=scores, worst_category=worst_category)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Ç–∫—É—é –∫–∞—Ä—Ç—É
    card_lines = []
    for cat in CATEGORY_ORDER:
        score = scores[cat]
        emoji = get_status_emoji(score)
        name = CATEGORY_NAMES[cat]
        card_lines.append(f"{emoji} {name}: {score}/4")
    
    card_text = "\n".join(card_lines)
    
    total_score = sum(scores.values())
    countdown = get_countdown_text()
    
    result_message = f"""üìä <b>–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!</b>

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
<b>–í–ê–®–ê –ö–ê–†–¢–ê –ë–ò–ó–ù–ï–°–ê:</b>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

{card_text}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üéØ <b>–ò—Ç–æ–≥–æ–≤—ã–π –¥–∏–∞–≥–Ω–æ–∑:</b>
–í–∞—à–µ–º—É –±–∏–∑–Ω–µ—Å—É –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Üí <b>{worst_name}</b>

–ü–æ–∫–∞ —ç—Ç–æ—Ç —É–∑–µ–ª –Ω–µ —Ä–∞–∑–≤—è–∑–∞–Ω, –ª—é–±—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è –≤ —Ä–µ–∫–ª–∞–º—É –∏–ª–∏ –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –±—É–¥—É—Ç –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

–ù–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–µ <b>¬´–ö–û–î –†–û–°–¢–ê¬ª</b> –º—ã –Ω–µ –±—É–¥–µ–º –ø—Ä–æ—Å—Ç–æ "—É—á–∏—Ç—å—Å—è". –ú—ã –≤–æ–∑—å–º—ë–º –≤–∞—à—É –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∫–∞—Ä—Ç—É –∏ –∑–∞ 5 –¥–Ω–µ–π –∑–∞–º–µ–Ω–∏–º "–∫—Ä–∞—Å–Ω—ã–µ –∑–æ–Ω—ã" –Ω–∞ —Ä–∞–±–æ—á–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:

‚úÖ –î–µ–Ω—å 1: –ü–æ—Å—á–∏—Ç–∞–µ–º –≤–∞—à—É —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å –∏ —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫—É
‚úÖ –î–µ–Ω—å 2: –ù–∞–π–¥—ë–º —Ç–æ—á–∫–∏ –ø–æ—Ç–µ—Ä—å –∏ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∏–º —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
‚úÖ –î–µ–Ω—å 3: –ü–æ—Å—Ç—Ä–æ–∏–º –≤–æ—Ä–æ–Ω–∫—É –ø—Ä–æ–¥–∞–∂ –∏ –ø—Ä–æ–ø–∏—à–µ–º —Å–∫—Ä–∏–ø—Ç—ã
‚úÖ –î–µ–Ω—å 4: –ù–∞—Å—Ç—Ä–æ–∏–º —Å–∏—Å—Ç–µ–º—É –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ –∏ —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–æ–π
‚úÖ –î–µ–Ω—å 5: –°–æ–∑–¥–∞–¥–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–ª–∞–Ω –Ω–∞ 90 –¥–Ω–µ–π

{countdown}

–£ –≤–∞—Å –Ω–∞ —Ä—É–∫–∞—Ö –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø–ª–∞–Ω –Ω–∞ 90 –¥–Ω–µ–π –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—ã–π –∂–µ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫."""

    await message.edit_text(
        result_message,
        parse_mode="HTML",
        reply_markup=get_details_keyboard()
    )
    
    # –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    utm_source = data.get("utm_source", "")
    logger.info(f"User {user_id} completed diagnostic. Scores: {scores}. Tag: {tag}. UTM: {utm_source}")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
    save_result_to_file(data, scores, tag)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Google –¢–∞–±–ª–∏—Ü—É
    await save_to_google_form(data, scores, tag)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–µ–ø–æ—á–∫—É –¥–æ–∂–∏–º–∞ (3 —Å–æ–æ–±—â–µ–Ω–∏—è)
    tasks = []
    tasks.append(asyncio.create_task(send_followup_1(user_id, worst_category, worst_name, scores)))
    tasks.append(asyncio.create_task(send_followup_2(user_id, worst_category)))
    tasks.append(asyncio.create_task(send_followup_3(user_id)))
    followup_tasks[user_id] = tasks

@dp.callback_query(F.data == "show_details")
async def show_details(callback: types.CallbackQuery, state: FSMContext):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –ø–æ –±–ª–æ–∫–∞–º"""
    await callback.answer()
    
    data = await state.get_data()
    scores = data.get("scores", {})
    
    if not scores:
        await callback.message.answer("–ü—Ä–æ–π–¥–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∑–∞–Ω–æ–≤–æ: /start")
        return
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä
    details = ["üìã <b>–ü–û–î–†–û–ë–ù–´–ô –†–ê–ó–ë–û–† –ü–û –ë–õ–û–ö–ê–ú:</b>\n"]
    
    for cat in CATEGORY_ORDER:
        score = scores.get(cat, 0)
        name = CATEGORY_NAMES[cat]
        text = get_status_text(cat, score)
        details.append(f"\n<b>{name} ({score}/4)</b>\n{text}")
    
    details_text = "\n".join(details)
    
    await callback.message.answer(
        details_text,
        parse_mode="HTML",
        reply_markup=get_final_keyboard()
    )

# ============== –¶–ï–ü–û–ß–ö–ê –î–û–ñ–ò–ú–ê ==============

async def send_followup_1(user_id: int, worst_category: str, worst_name: str, scores: dict):
    """–°–æ–æ–±—â–µ–Ω–∏–µ 1: —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–æ —Å–ª–∞–±—É—é –∑–æ–Ω—É"""
    try:
        await asyncio.sleep(FOLLOWUP_DELAYS["first"])
        
        worst_text = get_status_text(worst_category, scores.get(worst_category, 0))
        countdown = get_countdown_text()
        
        followup_text = f"""üëã –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –±–æ—Ç ¬´–ö–û–î –†–û–°–¢–ê¬ª.

–í—ã –ø—Ä–æ—à–ª–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∏ —É–≤–∏–¥–µ–ª–∏ —Å–≤–æ–∏ —Å–ª–∞–±—ã–µ –∑–æ–Ω—ã.

–ù–∞–ø–æ–º–Ω—é –≤–∞—à –≥–ª–∞–≤–Ω—ã–π —Å—Ç–æ–ø-—Ñ–∞–∫—Ç–æ—Ä:

<b>üéØ {worst_name}</b>

{worst_text}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

–ò–º–µ–Ω–Ω–æ —Å —ç—Ç–∏–º –º—ã —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–µ.

{countdown}

–û—Å—Ç–∞–ª–æ—Å—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç üëá"""

        await bot.send_message(
            user_id,
            followup_text,
            parse_mode="HTML",
            reply_markup=get_followup_keyboard()
        )
        logger.info(f"Followup 1 sent to user {user_id}")
        
    except asyncio.CancelledError:
        logger.info(f"Followup 1 cancelled for user {user_id}")
    except Exception as e:
        logger.error(f"Error sending followup 1 to {user_id}: {e}")


async def send_followup_2(user_id: int, worst_category: str):
    """–°–æ–æ–±—â–µ–Ω–∏–µ 2: —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–µ–π—Å"""
    try:
        await asyncio.sleep(FOLLOWUP_DELAYS["second"])
        
        case_data = FOLLOWUP_CASES.get(worst_category, FOLLOWUP_CASES["finance"])
        countdown = get_countdown_text()
        
        followup_text = f"""üìå <b>–†–µ–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è: {case_data['title']}</b>

{case_data['case']}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

{case_data['day_link']}

{countdown}

üëá –ó–∞–±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ –º–µ—Å—Ç–æ, –ø–æ–∫–∞ –æ–Ω–∏ –µ—Å—Ç—å:"""

        await bot.send_message(
            user_id,
            followup_text,
            parse_mode="HTML",
            reply_markup=get_followup_keyboard()
        )
        logger.info(f"Followup 2 (case) sent to user {user_id}")
        
    except asyncio.CancelledError:
        logger.info(f"Followup 2 cancelled for user {user_id}")
    except Exception as e:
        logger.error(f"Error sending followup 2 to {user_id}: {e}")


async def send_followup_3(user_id: int):
    """–°–æ–æ–±—â–µ–Ω–∏–µ 3: —á–µ—Ä–µ–∑ 72 —á–∞—Å–∞ ‚Äî —Å—Ä–æ—á–Ω–æ—Å—Ç—å –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ"""
    try:
        await asyncio.sleep(FOLLOWUP_DELAYS["third"])
        
        days_left = get_days_until_start()
        countdown = get_countdown_text()
        
        if days_left <= 0:
            # –ò–Ω—Ç–µ–Ω—Å–∏–≤ —É–∂–µ –Ω–∞—á–∞–ª—Å—è, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
            return
        
        followup_text = f"""‚è∞ <b>–≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.</b>

–í—ã –ø—Ä–æ—à–ª–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∏ —É–≤–∏–¥–µ–ª–∏ –∫—Ä–∞—Å–Ω—ã–µ –∑–æ–Ω—ã –≤ –±–∏–∑–Ω–µ—Å–µ. –í–æ–ø—Ä–æ—Å ‚Äî —á—Ç–æ –≤—ã —Å —ç—Ç–∏–º —Å–¥–µ–ª–∞–µ—Ç–µ?

–ú–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å. –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä—É—Ç–∏–Ω–µ. –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ç–µ—Ä—è—Ç—å –¥–µ–Ω—å–≥–∏ –≤ —Ç–µ—Ö –∂–µ –º–µ—Å—Ç–∞—Ö.

–ê –º–æ–∂–Ω–æ –∑–∞ 5 –¥–Ω–µ–π –ø–æ–ª—É—á–∏—Ç—å:
‚úÖ –¢–∞–±–ª–∏—Ü—É —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∏ –≤–∞—à–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
‚úÖ –í–æ—Ä–æ–Ω–∫—É –ø—Ä–æ–¥–∞–∂ —Å —Ü–∏—Ñ—Ä–∞–º–∏ –ø–æ –∫–∞–∂–¥–æ–º—É —ç—Ç–∞–ø—É
‚úÖ –î–≤–∞ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–¥–∞–∂
‚úÖ –ú–∞—Ç—Ä–∏—Ü—É –∑–∞–¥–∞—á —Å –ø–ª–∞–Ω–æ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚úÖ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ 90 –¥–Ω–µ–π

<b>{countdown}</b>

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ —Ä–∞–∑–º–µ—Ä–æ–º –≥—Ä—É–ø–ø—ã ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º —Å –∫–∞–∂–¥—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –ª–∏—á–Ω–æ.

üëá –†–µ—à–∏—Ç–µ —Å–µ–π—á–∞—Å:"""

        await bot.send_message(
            user_id,
            followup_text,
            parse_mode="HTML",
            reply_markup=get_followup_keyboard()
        )
        logger.info(f"Followup 3 (urgency) sent to user {user_id}")
        
    except asyncio.CancelledError:
        logger.info(f"Followup 3 cancelled for user {user_id}")
    except Exception as e:
        logger.error(f"Error sending followup 3 to {user_id}: {e}")

# ============== –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• ==============

def save_result_to_file(data: dict, scores: dict, tag: str):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–∞–π–ª CSV —Å UTM-–º–µ—Ç–∫–æ–π"""
    try:
        with open("results.csv", "a", encoding="utf-8") as f:
            user_id = data.get("user_id", "")
            username = data.get("username", "")
            first_name = data.get("first_name", "")
            start_time = data.get("start_time", "")
            utm_source = data.get("utm_source", "")
            answers = ",".join(data.get("answers", []))
            scores_str = ";".join([f"{cat}:{scores[cat]}" for cat in CATEGORY_ORDER])
            total = sum(scores.values())
            
            line = f"{start_time}|{user_id}|@{username}|{first_name}|{scores_str}|total:{total}|{tag}|{utm_source}|{answers}\n"
            f.write(line)
            
        logger.info(f"Result saved for user {user_id} (UTM: {utm_source})")
    except Exception as e:
        logger.error(f"Error saving result: {e}")

async def save_to_google_form(data: dict, scores: dict, tag: str):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Google Form (–∏ –¥–∞–ª–µ–µ –≤ Google –¢–∞–±–ª–∏—Ü—É)"""
    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–≥ —Å UTM-–º–µ—Ç–∫–æ–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
        utm_source = data.get("utm_source", "")
        combined_tag = f"{tag}|{utm_source}" if utm_source else tag
        
        form_data = {
            FORM_FIELDS["user_id"]: str(data.get("user_id", "")),
            FORM_FIELDS["username"]: f"@{data.get('username', '')}",
            FORM_FIELDS["name"]: data.get("first_name", ""),
            FORM_FIELDS["finance"]: str(scores.get("finance", 0)),
            FORM_FIELDS["sales"]: str(scores.get("sales", 0)),
            FORM_FIELDS["processes"]: str(scores.get("processes", 0)),
            FORM_FIELDS["team"]: str(scores.get("team", 0)),
            FORM_FIELDS["strategy"]: str(scores.get("strategy", 0)),
            FORM_FIELDS["total"]: str(sum(scores.values())),
            FORM_FIELDS["tag"]: combined_tag,
        }
        
        async with aiohttp.ClientSession() as session:
            async with session.post(GOOGLE_FORM_URL, data=form_data) as response:
                if response.status == 200:
                    logger.info(f"Result sent to Google Form for user {data.get('user_id')}")
                else:
                    logger.warning(f"Google Form response: {response.status}")
                    
    except Exception as e:
        logger.error(f"Error sending to Google Form: {e}")

# ============== –ó–ê–ü–£–°–ö ==============

async def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    logger.info("Bot v4.0 starting...")
    logger.info(f"Intensive start date: {INTENSIVE_START_DATE}")
    logger.info(f"Days until start: {get_days_until_start()}")
    
    # –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    try:
        with open("results.csv", "r", encoding="utf-8") as f:
            pass
    except FileNotFoundError:
        with open("results.csv", "w", encoding="utf-8") as f:
            f.write("datetime|user_id|username|name|scores|total|tag|utm_source|answers\n")
    
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞–∫–æ–ø–∏–≤—à–∏–µ—Å—è –ø–æ–∫–∞ –±–æ—Ç –±—ã–ª –æ—Ñ–ª–∞–π–Ω
    try:
        await bot.delete_webhook(drop_pending_updates=True)
    except Exception as e:
        logger.warning(f"Could not delete webhook: {e}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º polling —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    await dp.start_polling(
        bot,
        allowed_updates=["message", "callback_query"],
        polling_timeout=30
    )

if __name__ == "__main__":
    asyncio.run(main())
